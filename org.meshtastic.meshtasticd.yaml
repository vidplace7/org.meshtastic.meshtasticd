id: org.meshtastic.meshtasticd
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: meshtasticd-wrapper.sh

finish-args:
  - --share=ipc
  # Allow the app to communicate with the X server
  - --socket=x11
  # Required for CH341 USB radio
  - --device=all
  # Needs network access
  - --share=network
  # Allow bluetooth if available
  - --allow=bluetooth

modules:
  - name: meshtasticd-wrapper
    buildsystem: simple
    build-commands:
      - install -Dm755 meshtasticd-wrapper.sh /app/bin/meshtasticd-wrapper.sh
    sources:
      - type: file
        path: meshtasticd-wrapper.sh
  - name: meshtasticd
    buildsystem: simple
    build-options:
      env:
        # Use the Flatpak lib directory for the build
        PLATFORMIO_BUILD_FLAGS: -L/app/lib
        # Use PlatformIO dependencies from the source bundle
        PLATFORMIO_LIBDEPS_DIR: pio/libdeps
        PLATFORMIO_PACKAGES_DIR: pio/packages
        PLATFORMIO_CORE_DIR: pio/core
    build-commands:
      # Install desktop metadata
      - install -Dm644 -t /app/share/icons/hicolor/scalable/apps bin/org.meshtastic.meshtasticd.svg
      - install -Dm644 -t /app/share/applications bin/org.meshtastic.meshtasticd.desktop
      - desktop-file-edit --set-key="Exec" --set-value="meshtasticd-wrapper.sh %U"
        /app/share/applications/org.meshtastic.meshtasticd.desktop
      - install -Dm644 -t /app/share/metainfo bin/org.meshtastic.meshtasticd.metainfo.xml
      # Override platformio version in appstate.json (prevent self-upgrade)
      - |
        sed -i 's/"last_version":[[:space:]]*"[^"]*"/"last_version": "6.1.19"/' pio/core/appstate.json
      # Build meshtasticd
      - platformio run -e native-tft
      - install -Dm755 .pio/build/native-tft/program /app/bin/meshtasticd
      # Install the default config files and directories
      - install -d /app/share/meshtasticd
      - install -d /app/share/meshtasticd/config.d
      - install -d /app/share/meshtasticd/available.d
      - cp -R bin/config.d/* /app/share/meshtasticd/available.d
      - install -m644 bin/config-dist.yaml /app/share/meshtasticd/config-dist.yaml
      # Install the default maps
      - install -d /app/share/meshtasticd/maps
      - for file in pio/libdeps/native-tft/meshtastic-device-ui/maps/*.zip; do bsdtar
        -xf "$file" --no-same-owner --strip-components=1 -C /app/share/meshtasticd/maps;
        done
    sources:
      - type: git
        url: https://github.com/meshtastic/firmware.git
        tag: v2.7.16.a597230
        commit: a59723030a7e15ab53b6fd1cb264ba2eebd4ed46
        x-checker-data:
          is-main-source: true
          type: json
          url: https://api.github.com/repos/meshtastic/firmware/releases/latest
          timestamp-query: .published_at
          tag-query: .tag_name
          version-query: $tag | sub("^v"; "")
      - type: patch
        paths:
          - patches/stdcppfs.patch
      - type: archive
        url: https://github.com/meshtastic/firmware/releases/download/v2.7.16.a597230/platformio-deps-native-tft-2.7.16.a597230.zip
        sha256: c5bd2306b82623187f688c33a1a1912b5120d0f3f5a3ba05851ef1069a551ee4
        strip-components: 1
        dest: pio
        x-checker-data:
          is-main-source: true
          type: json
          url: https://api.github.com/repos/meshtastic/firmware/releases/latest
          timestamp-query: .published_at
          version-query: .tag_name | sub("^v"; "")
          url-query: |-
            .assets[] | select(.name=="platformio-deps-native-tft-" + $version + ".zip") | .browser_download_url
    cleanup:
      - /include
      - /lib/pkgconfig
      - /lib/cmake
      - /lib/*.a
      - /share/man
    modules:
      - python3-requirements.yaml
      - name: yaml-cpp
        buildsystem: cmake-ninja
        config-opts:
          - -DBUILD_SHARED_LIBS=ON
          - -DYAML_BUILD_SHARED_LIBS=ON
          - -DYAML_CPP_BUILD_TOOLS=OFF
          - -DYAML_CPP_BUILD_TESTS=OFF
          - -DYAML_CPP_BUILD_CONTRIB=OFF
        sources:
          - type: archive
            # Include unreleased CMake fixes
            # Revisit when >0.8.0 has been released
            url: https://github.com/jbeder/yaml-cpp/archive/2f86d13775d119edbb69af52e5f566fd65c6953b.zip
            sha256: a0fe4a51bdc90bf6070e59434a4bcd59a7e55def747c8749ac0103d152bb8072
            # x-checker-data:
            #   type: anitya
            #   project-id: 5284
            #   stable-only: true
            #   url-template: https://github.com/jbeder/yaml-cpp/archive/refs/tags/$version.tar.gz
      - name: libgpiod
        buildsystem: autotools
        sources:
          - type: archive
            url: https://git.kernel.org/pub/scm/libs/libgpiod/libgpiod.git/snapshot/libgpiod-2.2.2.tar.gz
            sha256: d0b1380c3cbabbb49b82f709b3288376d98347d4436613407d19cc4cbbfc45a6
            x-checker-data:
              type: anitya
              project-id: 20640
              stable-only: true
              url-template: https://git.kernel.org/pub/scm/libs/libgpiod/libgpiod.git/snapshot/libgpiod-$version.tar.gz
      - name: i2c-tools
        buildsystem: simple
        build-commands:
          - make PREFIX=${FLATPAK_DEST} install
        sources:
          - type: archive
            url: https://git.kernel.org/pub/scm/utils/i2c-tools/i2c-tools.git/snapshot/i2c-tools-4.4.tar.gz
            sha256: af01d0fbe78e109a2db7137c7e9bfda3f3fb236c3177744c0f2695d1056cde71
            x-checker-data:
              type: anitya
              project-id: 9272
              stable-only: true
              url-template: https://git.kernel.org/pub/scm/utils/i2c-tools/i2c-tools.git/snapshot/i2c-tools-$version.tar.gz
      - name: libuv
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
        sources:
          - type: git
            url: https://github.com/libuv/libuv/
            tag: v1.51.0
            x-checker-data:
              type: anitya
              project-id: 10784
              stable-only: true
              tag-template: v${version}
            commit: 5152db2cbfeb5582e9c27c5ea1dba2cd9e10759b
        cleanup:
          - /bin
      - name: libevdev
        buildsystem: meson
        config-opts:
          - -Dtests=disabled
          - -Ddocumentation=disabled
        sources:
          - type: archive
            url: https://www.freedesktop.org/software/libevdev/libevdev-1.13.5.tar.xz
            sha256: 89918ae7b7c13936e6482604a77a2bfbbb74544c5d039fde01c3fa1bdf639987
            x-checker-data:
              type: anitya
              project-id: 20540
              stable-only: true
              url-template: https://www.freedesktop.org/software/libevdev/libevdev-$version.tar.xz
        cleanup:
          - /bin
      - name: libinput
        buildsystem: meson
        config-opts:
          - --libexec=lib
          - -Dlibwacom=false
          - -Ddebug-gui=false
          - -Dtests=false
          - -Ddocumentation=false
          - -Dzshcompletiondir=no
        sources:
          - type: archive
            url: https://gitlab.freedesktop.org/libinput/libinput/-/archive/1.30.0/libinput-1.30.0.tar.gz
            sha256: fcce701746b8f5ee57c6724e963496d2223a9639856c6d1b811cff38e6dd4465
            x-checker-data:
              type: anitya
              project-id: 5781
              stable-only: true
              url-template: https://gitlab.freedesktop.org/libinput/libinput/-/archive/$version/libinput-$version.tar.gz
        cleanup:
          - /bin
          - /etc
          - /lib/libinput
          - /lib/udev
          - /share
        modules:
          - name: mtdev
            buildsystem: autotools
            config-opts:
              - --disable-static
            sources:
              - type: archive
                url: https://bitmath.org/code/mtdev/mtdev-1.1.7.tar.bz2
                mirror-urls:
                  - https://ftp.osuosl.org/pub/blfs/conglomeration/mtdev/mtdev-1.1.7.tar.bz2
                  - https://mirror.freedif.org/pub/blfs/conglomeration/mtdev/mtdev-1.1.7.tar.bz2
                sha256: a107adad2101fecac54ac7f9f0e0a0dd155d954193da55c2340c97f2ff1d814e
                x-checker-data:
                  type: anitya
                  project-id: 8868
                  stable-only: true
                  url-template: https://bitmath.org/code/mtdev/mtdev-$version.tar.bz2
              # Upstream uses an outdated version of the config.guess/config.sub script,
              # so we override it here to fix aarch64 builds.
              - type: shell
                commands:
                  - cp -p /usr/share/automake-*/config.{sub,guess} config-aux/
            cleanup:
              - /bin
              - /lib/*.la
      - name: xkbcommon
        buildsystem: meson
        config-opts:
          - --buildtype=release
          - -Ddefault_library=static
          - -Denable-docs=false
          - -Denable-tools=false
          - -Denable-bash-completion=false
          - -Dx-locale-root=/usr/share/X11/locale
        cleanup:
          - /bin
          - /libexec
        sources:
          - type: archive
            url: https://xkbcommon.org/download/libxkbcommon-1.7.0.tar.xz
            sha256: 65782f0a10a4b455af9c6baab7040e2f537520caa2ec2092805cdfd36863b247
            x-checker-data:
              type: anitya
              project-id: 1780
              stable-only: true
              url-template: https://xkbcommon.org/download/libxkbcommon-$version.tar.xz
